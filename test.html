<!-- Lemonade Preset Test Page -->

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Lemonade Preset Test Page</title>
 </head>
 <body>
    <h2>Lemonade Test Interface</h2>
    <!-- 
        Display a form with the following fields:
          - image: a file input
          - styles: comma separated list of styles to prepend to the prompt
          - num_images_per_style: number of images to generate per style
    -->
    <form action="test.php">
        image <input type="file" name="image" id="image"><br/>
        styles (separated by comma) <input type="text" name="styles" id="styles" placeholder="styles" value="archer,modern disney"><br/>
        num images per style <input type="text" name="num_images_per_style" id="num_images_per_style" placeholder="num_images_per_style" value="1"><br/>
        effect strength <input type="text" name="strength" id="strength" placeholder="strength" value="0.6"><br/>
        api token <input type="text" name="token" id="token" placeholder="token"><br/>
        <br />
        <input type="submit" value="Submit" name="submit"><br/>
    </form>

    <div id="input-image-container" style="visibility: hidden;">
        <h3>Input Selfie</h3>
        <img id="inputimage" src="" alt="input image" width="250" height="250">
    </div>

    <h3>Output Images</h3>
    <div id="results">
        <!-- 
            Display the results of the form submission here.
            The results should be a list of images generated by the server.
        -->
    </div>
    <h3>Extracted features</h3>
    <div id="answers">
        <!-- 
            Display the extracted features of the person.
        -->
        
    </div>

    <!-- 
        Logic to submit the form
        endpoint: https://rest.pollinations.ai/pollen
        fields:
          image: replicate:pollinations/lemonade-preset
          input: {
            "image": [base64 encoded image],
            "styles": "styles",
            "num_images_per_style": "num_images_per_style"
          }
    -->
    <script>
        const form = document.querySelector('form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // display input image
            document.getElementById("input-image-container").style.visibility = "visible";
            const inputImage = document.getElementById('inputimage');
            inputImage.src = URL.createObjectURL(document.getElementById('image').files[0]);

            const image = document.querySelector('#image').files[0];
            const styles = document.querySelector('#styles').value;
            const num_images_per_style = document.querySelector('#num_images_per_style').value;
            const strength = document.querySelector('#strength').value;
            const formData = new FormData();

            const body = {
                "image": "replicate:pollinations/lemonade-preset",
                "input": {
                    "image": await toBase64(image),
                    "styles": styles,
                    "num_images_per_style": num_images_per_style,
                    "strength": strength
                }
            }

            const response = await fetch('https://rest.pollinations.ai/pollen', {
                method: 'POST',
                body: JSON.stringify(body),
                headers: {
                    "Authorization": `Bearer ${document.querySelector('#token').value}`,
                    "Content-Type": "application/json"
                }
            });
            const data = await response.json();
            console.log(data)

            // parse images
            const avatarImageURLs = data?.output?.avatars;

            const results = document.querySelector('#results');
            results.innerHTML = '';
            avatarImageURLs.forEach((avatarImageURL) => {
                const img = document.createElement('img');
                img.src = avatarImageURL;
                img.width = img.height = 256;
                results.appendChild(img);
            });            

            // parse features
            const featuresJSON = JSON.parse(data?.output?.answers);
            const featuresString = 
                Object.entries(featuresJSON)
                    .map(([key, value]) => `<b>${key}:</b> ${value}`)
                    .join('<br/>');

            const answers = document.querySelector('#answers');
            answers.innerHTML = featuresString;

        });

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });
    </script>


    <script>
        const token = window.localStorage.getItem('token');
        if (token) {
            document.querySelector('#token').value = token;
        }
    </script>
 </body>

</html>
